"use strict";
// https://github.com/ethereum-optimism/optaimism/blob/master/packages/core-utils/src/watcher.ts
Object.defineProperty(exports, "__esModule", { value: true });
exports.Watcher = void 0;
/* External Imports */
const ethers_1 = require("ethers");
class Watcher {
    constructor(opts) {
        this.NUM_BLOCKS_TO_FETCH = 10000000;
        this.l1 = opts.l1;
        this.l2 = opts.l2;
    }
    async getMessageHashesFromL1Tx(l1TxHash) {
        return this.getMessageHashesFromTx(this.l1, l1TxHash);
    }
    async getMessageHashesFromL2Tx(l2TxHash) {
        return this.getMessageHashesFromTx(this.l2, l2TxHash);
    }
    async getL1TransactionReceipt(l2ToL1MsgHash, pollForPending = true) {
        return this.getTransactionReceipt(this.l2, l2ToL1MsgHash, pollForPending);
    }
    async getL2TransactionReceipt(l1ToL2MsgHash, pollForPending = true) {
        return this.getTransactionReceipt(this.l2, l1ToL2MsgHash, pollForPending);
    }
    async getMessageHashesFromTx(layer, txHash) {
        const receipt = await layer.provider.getTransactionReceipt(txHash);
        if (!receipt) {
            return [];
        }
        const msgHashes = [];
        for (const log of receipt.logs) {
            if (log.address === layer.messengerAddress && log.topics[0] === ethers_1.ethers.utils.id('SentMessage(bytes)')) {
                const [message] = ethers_1.ethers.utils.defaultAbiCoder.decode(['bytes'], log.data);
                msgHashes.push(ethers_1.ethers.utils.solidityKeccak256(['bytes'], [message]));
            }
        }
        return msgHashes;
    }
    async getTransactionReceipt(layer, msgHash, pollForPending = true) {
        const blockNumber = await layer.provider.getBlockNumber();
        const startingBlock = Math.max(blockNumber - this.NUM_BLOCKS_TO_FETCH, 0);
        const filter = {
            address: layer.messengerAddress,
            topics: [ethers_1.ethers.utils.id(`RelayedMessage(bytes32)`)],
            fromBlock: startingBlock,
        };
        const logs = await layer.provider.getLogs(filter);
        const matches = logs.filter((log) => log.data === msgHash);
        // Message was relayed in the past
        if (matches.length > 0) {
            if (matches.length > 1) {
                throw Error('Found multiple transactions relaying the same message hash.');
            }
            return layer.provider.getTransactionReceipt(matches[0].transactionHash);
        }
        if (!pollForPending) {
            return Promise.resolve(undefined);
        }
        // Message has yet to be relayed, poll until it is found
        return new Promise(async (resolve, reject) => {
            layer.provider.on(filter, async (log) => {
                if (log.data === msgHash) {
                    try {
                        const txReceipt = await layer.provider.getTransactionReceipt(log.transactionHash);
                        layer.provider.off(filter);
                        resolve(txReceipt);
                    }
                    catch (e) {
                        reject(e);
                    }
                }
            });
        });
    }
}
exports.Watcher = Watcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2hlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93YXRjaGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxnR0FBZ0c7OztBQUVoRyxzQkFBc0I7QUFDdEIsbUNBQStCO0FBYS9CLE1BQWEsT0FBTztJQUtsQixZQUFZLElBQW9CO1FBRnpCLHdCQUFtQixHQUFXLFFBQVUsQ0FBQTtRQUc3QyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUE7UUFDakIsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFBO0lBQ25CLENBQUM7SUFFTSxLQUFLLENBQUMsd0JBQXdCLENBQUMsUUFBZ0I7UUFDcEQsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUN2RCxDQUFDO0lBQ00sS0FBSyxDQUFDLHdCQUF3QixDQUFDLFFBQWdCO1FBQ3BELE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDdkQsQ0FBQztJQUVNLEtBQUssQ0FBQyx1QkFBdUIsQ0FDbEMsYUFBcUIsRUFDckIsaUJBQTBCLElBQUk7UUFFOUIsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUE7SUFDM0UsQ0FBQztJQUVNLEtBQUssQ0FBQyx1QkFBdUIsQ0FDbEMsYUFBcUIsRUFDckIsaUJBQTBCLElBQUk7UUFFOUIsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUE7SUFDM0UsQ0FBQztJQUVNLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxLQUFZLEVBQUUsTUFBYztRQUM5RCxNQUFNLE9BQU8sR0FBRyxNQUFNLEtBQUssQ0FBQyxRQUFRLENB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TSxDQUFDLENBQUMsQ0FBQyxDQUFBO3FCQUNWO2lCQUNGO1lBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRjtBQXhGRCwwQkF3RkMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBodHRwczovL2dpdGh1Yi5jb20vZXRoZXJldW0tb3B0aW1pc20vb3B0YWltaXNtL2Jsb2IvbWFzdGVyL3BhY2thZ2VzL2NvcmUtdXRpbHMvc3JjL3dhdGNoZXIudHNcblxuLyogRXh0ZXJuYWwgSW1wb3J0cyAqL1xuaW1wb3J0IHsgZXRoZXJzIH0gZnJvbSAnZXRoZXJzJ1xuaW1wb3J0IHsgUHJvdmlkZXIsIFRyYW5zYWN0aW9uUmVjZWlwdCB9IGZyb20gJ0BldGhlcnNwcm9qZWN0L2Fic3RyYWN0LXByb3ZpZGVyJ1xuXG5leHBvcnQgaW50ZXJmYWNlIExheWVyIHtcbiAgcHJvdmlkZXI6IFByb3ZpZGVyXG4gIG1lc3NlbmdlckFkZHJlc3M6IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFdhdGNoZXJPcHRpb25zIHtcbiAgbDE6IExheWVyXG4gIGwyOiBMYXllclxufVxuXG5leHBvcnQgY2xhc3MgV2F0Y2hlciB7XG4gIHB1YmxpYyBsMTogTGF5ZXJcbiAgcHVibGljIGwyOiBMYXllclxuICBwdWJsaWMgTlVNX0JMT0NLU19UT19GRVRDSDogbnVtYmVyID0gMTBfMDAwXzAwMFxuXG4gIGNvbnN0cnVjdG9yKG9wdHM6IFdhdGNoZXJPcHRpb25zKSB7XG4gICAgdGhpcy5sMSA9IG9wdHMubDFcbiAgICB0aGlzLmwyID0gb3B0cy5sMlxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldE1lc3NhZ2VIYXNoZXNGcm9tTDFUeChsMVR4SGFzaDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldE1lc3NhZ2VIYXNoZXNGcm9tVHgodGhpcy5sMSwgbDFUeEhhc2gpXG4gIH1cbiAgcHVibGljIGFzeW5jIGdldE1lc3NhZ2VIYXNoZXNGcm9tTDJUeChsMlR4SGFzaDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldE1lc3NhZ2VIYXNoZXNGcm9tVHgodGhpcy5sMiwgbDJUeEhhc2gpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0TDFUcmFuc2FjdGlvblJlY2VpcHQoXG4gICAgbDJUb0wxTXNnSGFzaDogc3RyaW5nLFxuICAgIHBvbGxGb3JQZW5kaW5nOiBib29sZWFuID0gdHJ1ZSxcbiAgKTogUHJvbWlzZTxUcmFuc2FjdGlvblJlY2VpcHQgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRUcmFuc2FjdGlvblJlY2VpcHQodGhpcy5sMiwgbDJUb0wxTXNnSGFzaCwgcG9sbEZvclBlbmRpbmcpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0TDJUcmFuc2FjdGlvblJlY2VpcHQoXG4gICAgbDFUb0wyTXNnSGFzaDogc3RyaW5nLFxuICAgIHBvbGxGb3JQZW5kaW5nOiBib29sZWFuID0gdHJ1ZSxcbiAgKTogUHJvbWlzZTxUcmFuc2FjdGlvblJlY2VpcHQgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRUcmFuc2FjdGlvblJlY2VpcHQodGhpcy5sMiwgbDFUb0wyTXNnSGFzaCwgcG9sbEZvclBlbmRpbmcpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0TWVzc2FnZUhhc2hlc0Zyb21UeChsYXllcjogTGF5ZXIsIHR4SGFzaDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHJlY2VpcHQgPSBhd2FpdCBsYXllci5wcm92aWRlci5nZXRUcmFuc2FjdGlvblJlY2VpcHQodHhIYXNoKVxuICAgIGlmICghcmVjZWlwdCkge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuXG4gICAgY29uc3QgbXNnSGFzaGVzID0gW11cbiAgICBmb3IgKGNvbnN0IGxvZyBvZiByZWNlaXB0LmxvZ3MpIHtcbiAgICAgIGlmIChsb2cuYWRkcmVzcyA9PT0gbGF5ZXIubWVzc2VuZ2VyQWRkcmVzcyAmJiBsb2cudG9waWNzWzBdID09PSBldGhlcnMudXRpbHMuaWQoJ1NlbnRNZXNzYWdlKGJ5dGVzKScpKSB7XG4gICAgICAgIGNvbnN0IFttZXNzYWdlXSA9IGV0aGVycy51dGlscy5kZWZhdWx0QWJpQ29kZXIuZGVjb2RlKFsnYnl0ZXMnXSwgbG9nLmRhdGEpXG4gICAgICAgIG1zZ0hhc2hlcy5wdXNoKGV0aGVycy51dGlscy5zb2xpZGl0eUtlY2NhazI1NihbJ2J5dGVzJ10sIFttZXNzYWdlXSkpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBtc2dIYXNoZXNcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRUcmFuc2FjdGlvblJlY2VpcHQoXG4gICAgbGF5ZXI6IExheWVyLFxuICAgIG1zZ0hhc2g6IHN0cmluZyxcbiAgICBwb2xsRm9yUGVuZGluZzogYm9vbGVhbiA9IHRydWUsXG4gICk6IFByb21pc2U8VHJhbnNhY3Rpb25SZWNlaXB0IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgYmxvY2tOdW1iZXIgPSBhd2FpdCBsYXllci5wcm92aWRlci5nZXRCbG9ja051bWJlcigpXG4gICAgY29uc3Qgc3RhcnRpbmdCbG9jayA9IE1hdGgubWF4KGJsb2NrTnVtYmVyIC0gdGhpcy5OVU1fQkxPQ0tTX1RPX0ZFVENILCAwKVxuICAgIGNvbnN0IGZpbHRlciA9IHtcbiAgICAgIGFkZHJlc3M6IGxheWVyLm1lc3NlbmdlckFkZHJlc3MsXG4gICAgICB0b3BpY3M6IFtldGhlcnMudXRpbHMuaWQoYFJlbGF5ZWRNZXNzYWdlKGJ5dGVzMzIpYCldLFxuICAgICAgZnJvbUJsb2NrOiBzdGFydGluZ0Jsb2NrLFxuICAgIH1cbiAgICBjb25zdCBsb2dzID0gYXdhaXQgbGF5ZXIucHJvdmlkZXIuZ2V0TG9ncyhmaWx0ZXIpXG4gICAgY29uc3QgbWF0Y2hlcyA9IGxvZ3MuZmlsdGVyKChsb2c6IGFueSkgPT4gbG9nLmRhdGEgPT09IG1zZ0hhc2gpXG5cbiAgICAvLyBNZXNzYWdlIHdhcyByZWxheWVkIGluIHRoZSBwYXN0XG4gICAgaWYgKG1hdGNoZXMubGVuZ3RoID4gMCkge1xuICAgICAgaWYgKG1hdGNoZXMubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyBFcnJvcignRm91bmQgbXVsdGlwbGUgdHJhbnNhY3Rpb25zIHJlbGF5aW5nIHRoZSBzYW1lIG1lc3NhZ2UgaGFzaC4nKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGxheWVyLnByb3ZpZGVyLmdldFRyYW5zYWN0aW9uUmVjZWlwdChtYXRjaGVzWzBdLnRyYW5zYWN0aW9uSGFzaClcbiAgICB9XG4gICAgaWYgKCFwb2xsRm9yUGVuZGluZykge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpXG4gICAgfVxuXG4gICAgLy8gTWVzc2FnZSBoYXMgeWV0IHRvIGJlIHJlbGF5ZWQsIHBvbGwgdW50aWwgaXQgaXMgZm91bmRcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGF5ZXIucHJvdmlkZXIub24oZmlsdGVyLCBhc3luYyAobG9nOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGxvZy5kYXRhID09PSBtc2dIYXNoKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHR4UmVjZWlwdCA9IGF3YWl0IGxheWVyLnByb3ZpZGVyLmdldFRyYW5zYWN0aW9uUmVjZWlwdChsb2cudHJhbnNhY3Rpb25IYXNoKVxuICAgICAgICAgICAgbGF5ZXIucHJvdmlkZXIub2ZmKGZpbHRlcilcbiAgICAgICAgICAgIHJlc29sdmUodHhSZWNlaXB0KVxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG59XG4iXX0=